# vim: ts=4 sw=4 et filetype=gdb
#
# Debug commands to help degugging ollvm/clang
#
# 'exec-file' must be set with 'clang' path to successfully run
# ollvm-*-debug-session macros. The easist way to do this is pass
# it via command line argument.

define set-breakpoints
    set $x=0
    break llvm::LPPassManager::runOnFunction
    commands
        set $x++
        printf "---> iteration %d", $x
        if ($x > 1)
            continue
        else
            thread apply all bt
        end
    end
end

define set-xse-breakpoints
    set $x=0
    break llvm::AbstractStringEncryptionPass::runOnModule
    commands
        set $x++
        printf "---> iteration %d", $x
        if ($x > 1)
            continue
        else
            thread apply all bt
        end
    end
end

define ollvm-xse-debug-session
    printf "Loading...\n"
    set logging on
    #set args -cc1 -triple thumbv5e-none-linux-androideabi -S -disable-free -disable-llvm-verifier -main-file-name dll.cpp -mrelocation-model pic -pic-level 2 -mthread-model posix -mdisable-fp-elim -fmath-errno -masm-verbose -no-integrated-as -mconstructor-aliases -munwind-tables -fuse-init-array -target-cpu arm1022e -target-feature +soft-float -target-feature +soft-float-abi -target-feature -neon -target-feature -crypto -target-abi aapcs-linux -msoft-float -mfloat-abi soft -g -dwarf-column-info -ffunction-sections -coverage-file /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/armeabi/objs/cryptopp562/dll.o -resource-dir /home/nick/devtools/ollvm-3.6/android-ndk-r14b-ollvm3.6/toolchains/ollvm3.6/prebuilt/linux-x86_64/bin/../lib/clang/3.6.1 -dependency-file /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/armeabi/objs/cryptopp562/dll.o.d -MT /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/armeabi/objs/cryptopp562/dll.o -MP -D NDEBUG -D ANDROID -D CRYPTOPP_DISABLE_ASM=1 -I /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/cryptopp562/./src -I /home/nick/devtools/ollvm-3.6/android-ndk-r14b-ollvm3.6/sources/cxx-stl/llvm-libc++/include -I /home/nick/devtools/ollvm-3.6/android-ndk-r14b-ollvm3.6/sources/cxx-stl/llvm-libc++abi/include -I /home/nick/devtools/ollvm-3.6/android-ndk-r14b-ollvm3.6/sources/android/support/include -I /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/cryptopp562 -isysroot /home/nick/devtools/ollvm-3.6/android-ndk-r14b-ollvm3.6/platforms/android-16/arch-arm -internal-isystem /home/nick/devtools/ollvm-3.6/android-ndk-r14b-ollvm3.6/platforms/android-16/arch-arm/usr/local/include -internal-isystem /home/nick/devtools/ollvm-3.6/android-ndk-r14b-ollvm3.6/toolchains/ollvm3.6/prebuilt/linux-x86_64/bin/../lib/clang/3.6.1/include -internal-externc-isystem /home/nick/devtools/ollvm-3.6/android-ndk-r14b-ollvm3.6/platforms/android-16/arch-arm/include -internal-externc-isystem /home/nick/devtools/ollvm-3.6/android-ndk-r14b-ollvm3.6/platforms/android-16/arch-arm/usr/include -Os -Wno-invalid-command-line-argument -Wno-unused-command-line-argument -Wformat -Werror=format-security -Wno-return-type -Wno-c++11-narrowing -std=c++11 -fdeprecated-macro -fno-dwarf-directory-asm -fdebug-compilation-dir /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni -ferror-limit 19 -fmessage-length 273 -fvisibility hidden -stack-protector 2 -mstackrealign -fno-signed-char -fobjc-runtime=gcc -fcxx-exceptions -fexceptions -fdiagnostics-show-option -vectorize-loops -vectorize-slp -mllvm -xse -o /tmp/dll-965046.s -x c++ /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/cryptopp562/dll.cpp
    set args -MMD -MP -MF /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/armeabi/objs-debug/cryptopp562/rdtables.o.d -gcc-toolchain /home/nick/projects/alcatel-pay/docker-llvm/android-ndk-r14b-ollvm3.6.1-release/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64 -fpic -ffunction-sections -funwind-tables -fstack-protector-strong -Wno-invalid-command-line-argument -Wno-unused-command-line-argument -no-canonical-prefixes -fno-integrated-as -g -target armv5te-none-linux-androideabi -march=armv5te -mtune=xscale -msoft-float -fno-exceptions -fno-rtti -mthumb -O0 -UNDEBUG -fno-limit-debug-info  -I/home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/cryptopp562/./src -I/home/nick/projects/alcatel-pay/docker-llvm/android-ndk-r14b-ollvm3.6.1-release/sources/cxx-stl/llvm-libc++/include -I/home/nick/projects/alcatel-pay/docker-llvm/android-ndk-r14b-ollvm3.6.1-release/sources/cxx-stl/llvm-libc++abi/include -I/home/nick/projects/alcatel-pay/docker-llvm/android-ndk-r14b-ollvm3.6.1-release/sources/android/support/include -I/home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/cryptopp562 -DANDROID -mllvm -xse -Wa,--noexecstack -Wformat -Werror=format-security -std=c++11  -Wno-c++11-narrowing -Wno-return-type -fexceptions -fvisibility=hidden -frtti -pipe -fPIC -DCRYPTOPP_DISABLE_ASM=1 -std=c++11  --sysroot /home/nick/projects/alcatel-pay/docker-llvm/android-ndk-r14b-ollvm3.6.1-release/platforms/android-16/arch-arm  -c  /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/cryptopp562/rdtables.cpp -o /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/armeabi/objs-debug/cryptopp562/rdtables.o 

    set follow-fork-mode child
    set-xse-breakpoints
    printf "String-Encryption debug session reset..\n\n"
end

define ollvm-bcf-debug-session
    printf "Loading...\n"
    set logging on
    #set args -MMD -MP -MF /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/armeabi/objs/utils/src/log/log.o.d -gcc-toolchain /home/nick/devtools/ollvm-4/android-ndk-r14b-ollvm3.6/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64 -fpic -ffunction-sections -funwind-tables -fstack-protector-strong -Wno-invalid-command-line-argument -Wno-unused-command-line-argument -no-canonical-prefixes -fno-integrated-as -g -target armv5te-none-linux-androideabi -march=armv5te -mtune=xscale -msoft-float -fno-exceptions -fno-rtti -mthumb -O0 -DNDEBUG  -I/home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/./src/ -I/home/nick/devtools/ollvm-4/android-ndk-r14b-ollvm3.6/sources/cxx-stl/llvm-libc++/include -I/home/nick/devtools/ollvm-4/android-ndk-r14b-ollvm3.6/sources/cxx-stl/llvm-libc++abi/include -I/home/nick/devtools/ollvm-4/android-ndk-r14b-ollvm3.6/sources/android/support/include -I/home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni -DANDROID -DFOO=1 -Werror -Wa,--noexecstack -Wformat -Werror=format-security -std=c++11   -fexceptions -fvisibility=hidden -frtti -pipe -fPIC -DCRYPTOPP_DISABLE_ASM=1 -std=c++11 -Wno-return-type -Wno-c++11-narrowing -mllvm -bcf --sysroot /home/nick/devtools/ollvm-4/android-ndk-r14b-ollvm3.6/platforms/android-16/arch-arm  -c  /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/src/log/log.cpp -o /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/armeabi/objs/utils/src/log/log.o
    set args -cc1 -triple x86_64-none-linux-android -emit-obj -mrelax-all -mnoexecstack -disable-free -disable-llvm-verifier -main-file-name crypto_factory.cpp -mrelocation-model pic -pic-level 2 -mthread-model posix -mdisable-fp-elim -fmath-errno -masm-verbose -mconstructor-aliases -munwind-tables -fuse-init-array -target-cpu x86-64 -target-feature +sse4.2 -target-feature +popcnt -g -dwarf-column-info -ffunction-sections -coverage-file /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/x86_64/objs-debug/utils/src/utils/crypto_factory.o -resource-dir /home/nick/devtools/android-ndk-r14b-ollvm3.6/toolchains/ollvm3.6/prebuilt/linux-x86_64/bin/../lib/clang/3.6.1 -dependency-file /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/x86_64/objs-debug/utils/src/utils/crypto_factory.o.d -MT /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/x86_64/objs-debug/utils/src/utils/crypto_factory.o -MP -U NDEBUG -D ANDROID -D FOO=1 -D CRYPTOPP_DISABLE_ASM=1 -I /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/./src/ -I /home/nick/devtools/android-ndk-r14b-ollvm3.6/sources/cxx-stl/llvm-libc++/include -I /home/nick/devtools/android-ndk-r14b-ollvm3.6/sources/cxx-stl/llvm-libc++abi/include -I /home/nick/devtools/android-ndk-r14b-ollvm3.6/sources/android/support/include -I /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni -isysroot /home/nick/devtools/android-ndk-r14b-ollvm3.6/platforms/android-21/arch-x86_64 -internal-isystem /home/nick/devtools/android-ndk-r14b-ollvm3.6/platforms/android-21/arch-x86_64/usr/local/include -internal-isystem /home/nick/devtools/android-ndk-r14b-ollvm3.6/toolchains/ollvm3.6/prebuilt/linux-x86_64/bin/../lib/clang/3.6.1/include -internal-externc-isystem /home/nick/devtools/android-ndk-r14b-ollvm3.6/platforms/android-21/arch-x86_64/include -internal-externc-isystem /home/nick/devtools/android-ndk-r14b-ollvm3.6/platforms/android-21/arch-x86_64/usr/include -O0 -Wno-invalid-command-line-argument -Wno-unused-command-line-argument -Werror -Wformat -Werror=format-security -Wno-return-type -Wno-c++11-narrowing -std=c++11 -fdeprecated-macro -fdebug-compilation-dir /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni -ferror-limit 19 -fmessage-length 273 -fvisibility hidden -fstandalone-debug -stack-protector 2 -mstackrealign -fobjc-runtime=gcc -fexceptions -fdiagnostics-show-option -fcxx-exceptions -mllvm -bcf -o /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/x86_64/objs-debug/utils/src/utils/crypto_factory.o -x c++ /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/src/utils/crypto_factory.cpp
	set args -cc1 -triple x86_64-none-linux-android -emit-obj -mrelax-all -mnoexecstack -disable-free -disable-llvm-verifier -main-file-name crypto_factory.cpp -mrelocation-model pic -pic-level 2 -mthread-model posix -mdisable-fp-elim -fmath-errno -masm-verbose -mconstructor-aliases -munwind-tables -fuse-init-array -target-cpu x86-64 -target-feature +sse4.2 -target-feature +popcnt -g -dwarf-column-info -ffunction-sections -coverage-file /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/x86_64/objs-debug/utils/src/utils/crypto_factory.o -resource-dir /home/nick/devtools/android-ndk-r14b-ollvm3.6/toolchains/ollvm3.6/prebuilt/linux-x86_64/bin/../lib/clang/3.6.1 -dependency-file /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/x86_64/objs-debug/utils/src/utils/crypto_factory.o.d -MT /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/x86_64/objs-debug/utils/src/utils/crypto_factory.o -MP -U NDEBUG -D ANDROID -D FOO=1 -D CRYPTOPP_DISABLE_ASM=1 -I /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/./src/ -I /home/nick/devtools/android-ndk-r14b-ollvm3.6/sources/cxx-stl/llvm-libc++/include -I /home/nick/devtools/android-ndk-r14b-ollvm3.6/sources/cxx-stl/llvm-libc++abi/include -I /home/nick/devtools/android-ndk-r14b-ollvm3.6/sources/android/support/include -I /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni -isysroot /home/nick/devtools/android-ndk-r14b-ollvm3.6/platforms/android-21/arch-x86_64 -internal-isystem /home/nick/devtools/android-ndk-r14b-ollvm3.6/platforms/android-21/arch-x86_64/usr/local/include -internal-isystem /home/nick/devtools/android-ndk-r14b-ollvm3.6/toolchains/ollvm3.6/prebuilt/linux-x86_64/bin/../lib/clang/3.6.1/include -internal-externc-isystem /home/nick/devtools/android-ndk-r14b-ollvm3.6/platforms/android-21/arch-x86_64/include -internal-externc-isystem /home/nick/devtools/android-ndk-r14b-ollvm3.6/platforms/android-21/arch-x86_64/usr/include -O0 -Wno-invalid-command-line-argument -Wno-unused-command-line-argument -Werror -Wformat -Werror=format-security -Wno-return-type -Wno-c++11-narrowing -std=c++11 -fdeprecated-macro -fdebug-compilation-dir /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni -fcxx-exceptions -mllvm -bcf -o /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/obj/local/x86_64/objs-debug/utils/src/utils/crypto_factory.o -x c++ /home/nick/projects/alcatel-pay/alcatel-pay-android/AlcatelPay/mastercard-sdk/mcbp-android/src/main/jni/src/utils/crypto_factory.cpp
    set follow-fork-mode child
    # FIXME breakpoints?
    printf "Bogus-Flow-Control debug session reset..\n\n"
end

define rr
	source ~/.gdb/clang.gdb
end

printf "~/.gdb/ollvm.gdb file loaded.\n"

